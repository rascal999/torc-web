{% extends "bootstrap/base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% import "bootstrap/fixes.html" as fixes %}
{% import "bootstrap/utils.html" as util %}

{% block styles %}
{{super()}}
<link rel="stylesheet" href="{{url_for('.static', filename='bootstrap.css')}}">
{% endblock %}

{% block content %}
{{util.flashed_messages(dismissible=True)}}

<script src="/static/FileSaver.min.js"></script>
<script src="/static/jszip.min.js"></script>
<script src="/static/jszip-utils.js"></script>
<link rel="stylesheet" href="/static/bootstrap-table.css">
<script src="/static/bootstrap.min.js"></script>
<script src="/static/jquery.min.js"></script>
<script src="/static/bootstrap-table.js"></script>

<div class="container">
  <ul class="nav nav-tabs">
    <li class="active"><a data-toggle="tab" href="#tool">Tool</a></li>
    <li><a data-toggle="tab" href="#assessment">Assessment</a></li>
    <li><a data-toggle="tab" href="#jobs">Jobs</a></li>
  </ul>

  <div class="tab-content">
    <div id="tool" class="tab-pane fade in active">
      <h1>torc-web v0.1.5 - Tool Menu</h1>

      <form class="tool_form" id="tool_form" method=POST>
      {{ wtf.form_field(tool_form.tool) }}
      {{ wtf.form_field(tool_form.tool_target) }}
      {{ wtf.form_field(tool_form.tool_target_name) }}
      {{ wtf.form_field(tool_form.tool_port_number) }}
      {{ wtf.form_field(tool_form.tool_password) }}
      {{ wtf.form_field(tool_form.tool_password_file) }}
      {{ wtf.form_field(tool_form.tool_user) }}
      {{ wtf.form_field(tool_form.tool_user_file) }}
      {{ wtf.form_field(tool_form.tool_protocol) }}
      {{ wtf.form_field(tool_form.tool_url) }}
      </form>
      <button class="btn btn-success" id="submit_tool" type="button">Submit Job</button>
    </div>
    <div id="assessment" class="tab-pane fade">
      <h1>torc-web v0.1.5 - Assessment Menu</h1>

      <form class="assessment_form" id="assessment_form" method=POST>
      {{ wtf.form_field(assessment_form.assessment) }}
      {{ wtf.form_field(assessment_form.assessment_target) }}
      {{ wtf.form_field(assessment_form.assessment_target_name) }}
      {{ wtf.form_field(assessment_form.assessment_port_number) }}
      {{ wtf.form_field(assessment_form.assessment_password) }}
      {{ wtf.form_field(assessment_form.assessment_password_file) }}
      {{ wtf.form_field(assessment_form.assessment_user) }}
      {{ wtf.form_field(assessment_form.assessment_user_file) }}
      {{ wtf.form_field(assessment_form.assessment_protocol) }}
      {{ wtf.form_field(assessment_form.assessment_url) }}
      </form>
      <button class="btn btn-success" id="submit_assessment" type="button">Submit Job</button>
    </div>
    <div id="jobs" class="tab-pane fade">
      <h1>torc-web v0.1.5 - Jobs Menu</h1>
      <table id="table_job" class="table table-hover" data-toggle="table" data-url="http://127.0.0.1:5000/tools/jobs" data-pagination="true" data-search="true">
        <thead>
          <tr>
            <th data-field="id">Item ID</th>
            <th data-field="target_name">Job Name</th>
            <th data-field="target">Target Name</th>
            <th data-field="tool">Tool ID</th>
            <th data-field="return_code">Return Code</th>
            <th data-checkbox=true>Export</th>
            <th data-field="view" data-formatter="viewFormatter" data-events="viewEvents">View</th>
          </tr>
        </thead>
      </table>
      <div id="toolbar" style="padding-top: 5px; padding-bottom: 5px">
        <button class="btn btn-success" id="export_job" type="button">Export Job</button>
        <button class="btn btn-default" id="refresh" type="button">
          <i class="glyphicon glyphicon-refresh icon-refresh"></i>
        </button>
      </div>

    </div>
  </div>

<script>
    var $table = $('#table_job');
    var $button = $('button#export_job');
    var $button_refresh = $('button#refresh');

    function viewFormatter(value, row, index) {
        return [
            '<a href="/view?jobid=' + (index + 1) + '&_=' + new Date() / 1000 + '" target="_blank">View</a>',
        ].join('');
    }

    // Add file to zip
    function addToZip(zip, exportId, exportData) {
        var deferred = $.Deferred();
        var item = exportData[exportId];

        JSZipUtils.getBinaryContent('http://127.0.0.1:5000/tools/jobs/exports/' + item['id'], function(err, data) {
            var elt = document.getElementById('jszip_utils');
            if(err) {
                showError(elt, err);
                return;
            } else {
                zip.file(item['id'] + ".zip", data)
                deferred.resolve(zip);
            }
        });
        return deferred;
    }

    function generateZip(zip) {
        var content = zip.generate({type:"blob"});
        saveAs(content, "output.zip");
        //location.href = "data:application/zip;base64," + content;
    }

    // Refresh button
    $(function () {
        $button_refresh.click(function () {
            $table.bootstrapTable('refresh');
        });
    });

    // Export job
    $(function () {
        $button.click(function () {
            var exportData = $table.bootstrapTable('getSelections');
            var deferreds = [];
            var zip = new JSZip();

            for(var i=0;i<exportData.length;i++) {
                deferreds.push(addToZip(zip,i,exportData));
            }

            $.when.apply(window, deferreds).done(generateZip);
        });
    });

    $(function() {
        $("button#submit_tool").click(function(){
            var tool = document.getElementById('tool_form').elements[0].value;
            var target = document.getElementById('tool_form').elements[1].value;
            var target_name = document.getElementById('tool_form').elements[2].value;
            var port_number = document.getElementById('tool_form').elements[3].value;
            var password = document.getElementById('tool_form').elements[4].value;
            var password_file = document.getElementById('tool_form').elements[5].value;
            var user = document.getElementById('tool_form').elements[6].value;
            var user_file = document.getElementById('tool_form').elements[7].value;
            var protocol = document.getElementById('tool_form').elements[8].value;
            var url = document.getElementById('tool_form').elements[9].value;
            serialised = "tool=" + tool + "&target=" + target + "&target_name=" + target_name + "&port_number=" + port_number +
                         "&password=" + password + "&password_file=" + password_file + "&user=" + user + "&user_file=" + user_file +
                         "&protocol=" + protocol + "&url=" + url;
            executeTool(serialised,'tool');
        });
    });

    function executeTool(dataToPost,type) {
        // Very pikey code
        var fail = 0;
        if (type=='tool') {
            var target_original = tool_target.value;
            var list_target = tool_target.value.replace(/\r\n/g, "\n").split("\n");
        } else {
            var target_original = assessment_target.value;
            var list_target = assessment_target.value.replace(/\r\n/g, "\n").split("\n");
        }

        for(k=0;k<list_target.length;k++) {
            if (type=='tool') {
                document.getElementById('tool_target').value = list_target[k];
            } else {
                document.getElementById('assessment_target').value = list_target[k];
            }

            $.ajax({
                type: "POST",
                url: "http://localhost:5000/tools/jobs",
                data: dataToPost,
                success: function(msg){
                    $.ajax({
                        type: "POST",
                        url: "http://localhost:5000/tools/jobs/execute",
                        data: msg,
                        success: function(response){
                            ;
                        },
                        error: function(){
                            fail = 1;
                        }
                    });
                },
                error: function(){
                    fail = 1;
                }
            });
        }

        // Restore original value(s) to target list
        if (type=='tool') {
            tool_target.value = target_original;
        } else {
            assessment_target.value = target_original;
        }

        if (fail == 1) {
            if (type=='tool') {
                alert("Failure");
            } else {
                return 1;
            }
        } else {
            if (type=='tool') {
                alert("Success");
            } else {
                return 0;
            }
        }
    }

    // Process tool array
    function processToolArray(tool_array) {
        var errors = 0;

        var tool = document.getElementById('assessment_form').elements[0].value;
        var target = document.getElementById('assessment_form').elements[1].value;
        var target_name = document.getElementById('assessment_form').elements[2].value;
        var port_number = document.getElementById('assessment_form').elements[3].value;
        var password = document.getElementById('assessment_form').elements[4].value;
        var password_file = document.getElementById('assessment_form').elements[5].value;
        var user = document.getElementById('assessment_form').elements[6].value;
        var user_file = document.getElementById('assessment_form').elements[7].value;
        var protocol = document.getElementById('assessment_form').elements[8].value;
        var url = document.getElementById('assessment_form').elements[9].value;

        for(i=0;i<tool_array.result[0].tools.length;i++) {
            serialised = "tool=" + tool_array.result[0].tools[i].tool + "&target=" + target + "&target_name=" + target_name +
                     "&port_number=" + port_number + "&password=" + password + "&password_file=" + password_file + "&user=" +
                     user + "&user_file=" + user_file + "&protocol=" + protocol + "&url=" + url;
            errors = errors + executeTool(serialised,'assessment');
        }

        if (errors == 0) {
            alert("Success");
        } else {
            alert("One or more tools failed");
        }
   }

    $(function() {
        // For each tool in assessment...
        $("button#submit_assessment").click(function(){
            var xmlhttp = new XMLHttpRequest();
            var url = "http://127.0.0.1:5000/assessments/" + document.getElementById('assessment_form').elements[0].value;

            xmlhttp.onreadystatechange = function() {
                if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                    var tool_array = JSON.parse(xmlhttp.responseText);
                    processToolArray(tool_array);
                }
            };

            xmlhttp.open("GET", url, true);
            xmlhttp.send();
        });
    });
</script>

{% endblock %}

{% block head %}
{{super()}}
{{fixes.ie8()}}

{% endblock %}
